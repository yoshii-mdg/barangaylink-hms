
// File: server/index.js
```js
import express from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import { createClient } from '@supabase/supabase-js';

dotenv.config();

const app = express();
app.use(cors({ origin: process.env.CLIENT_ORIGIN || 'http://localhost:5173' }));
app.use(express.json());

// Service role client — server-side only, never exposed to the browser
const supabaseAdmin = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

// ── Auth middleware ──────────────────────────────────────────────────────────
async function requireSuperAdmin(req, res, next) {
  const token = req.headers.authorization?.replace('Bearer ', '');
  if (!token) return res.status(401).json({ error: 'Missing auth token' });

  const { data: { user }, error } = await supabaseAdmin.auth.getUser(token);
  if (error || !user) return res.status(401).json({ error: 'Invalid token' });

  const { data: profile } = await supabaseAdmin
    .from('users_tbl')
    .select('role')
    .eq('user_id', user.id)
    .maybeSingle();

  if (profile?.role !== 'superadmin') {
    return res.status(403).json({ error: 'Forbidden: superadmin only' });
  }

  req.adminUser = user;
  next();
}

// ── Routes ───────────────────────────────────────────────────────────────────

app.get('/', (_req, res) => res.send('BarangayLink backend running'));

/**
 * List all users (profiles + auth emails merged).
 *
 * BUG FIX: Removed `invited_by` from SELECT — that column does NOT exist in
 * users_tbl per the schema. Selecting a non-existent column causes Supabase
 * to return 400, breaking the entire User Management page.
 */
app.get('/api/admin/users', requireSuperAdmin, async (_req, res) => {
  try {
    const [{ data: profiles, error: profileError }, { data: authData, error: authError }] =
      await Promise.all([
        supabaseAdmin
          .from('users_tbl')
          .select('id, user_id, first_name, middle_name, last_name, role, is_active, created_at')
          .order('last_name', { ascending: true }),
        supabaseAdmin.auth.admin.listUsers(),
      ]);

    if (profileError) throw profileError;
    if (authError) throw authError;

    const emailMap = Object.fromEntries(
      (authData?.users ?? []).map((u) => [u.id, u.email])
    );

    res.json(
      (profiles ?? []).map((p) => ({ ...p, email: emailMap[p.user_id] ?? '' }))
    );
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

/**
 * Invite a staff member by email.
 * The DB trigger (handle_new_user) will auto-create the users_tbl row,
 * but we also upsert here as a safety net in case the trigger hasn't been
 * installed yet.
 */
app.post('/api/admin/invite', requireSuperAdmin, async (req, res) => {
  const { email } = req.body;
  if (!email) return res.status(400).json({ error: 'email is required' });

  try {
    const { data, error: inviteError } = await supabaseAdmin.auth.admin.inviteUserByEmail(email, {
      data: { role: 'staff' },
      redirectTo: `${process.env.CLIENT_ORIGIN || 'http://localhost:5173'}/accept-invitation`,
    });
    if (inviteError) throw inviteError;

    // Safety-net upsert (the DB trigger should have already done this)
    if (data?.user?.id) {
      await supabaseAdmin
        .from('users_tbl')
        .upsert(
          {
            user_id:    data.user.id,
            email,                      // NOT NULL in schema — must include
            role:       'staff',
            is_active:  false,
            first_name: '',
            middle_name: null,
            last_name:  '',
          },
          { onConflict: 'user_id', ignoreDuplicates: true }
        );
    }

    res.json({ ok: true });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// Change a user's role
app.patch('/api/admin/users/:userId/role', requireSuperAdmin, async (req, res) => {
  const { userId } = req.params;
  const { role } = req.body;
  const validRoles = ['superadmin', 'staff', 'resident'];

  if (!validRoles.includes(role)) return res.status(400).json({ error: 'Invalid role' });

  try {
    const { error } = await supabaseAdmin
      .from('users_tbl')
      .update({ role, updated_at: new Date().toISOString() })
      .eq('user_id', userId);
    if (error) throw error;
    res.json({ ok: true });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// Deactivate a user
app.patch('/api/admin/users/:userId/deactivate', requireSuperAdmin, async (req, res) => {
  const { userId } = req.params;
  try {
    const { error } = await supabaseAdmin
      .from('users_tbl')
      .update({ is_active: false, updated_at: new Date().toISOString() })
      .eq('user_id', userId);
    if (error) throw error;
    res.json({ ok: true });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// Reactivate a user
app.patch('/api/admin/users/:userId/reactivate', requireSuperAdmin, async (req, res) => {
  const { userId } = req.params;
  try {
    const { error } = await supabaseAdmin
      .from('users_tbl')
      .update({ is_active: true, updated_at: new Date().toISOString() })
      .eq('user_id', userId);
    if (error) throw error;
    res.json({ ok: true });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

/**
 * Activate own profile after accepting invitation.
 * Called by the invited user themselves — no superadmin check.
 * Also accepts optional name fields to update the profile at the same time.
 */
app.patch('/api/admin/users/:userId/activate', async (req, res) => {
  const { userId } = req.params;
  const { first_name, middle_name, last_name } = req.body ?? {};

  const token = req.headers.authorization?.replace('Bearer ', '');
  if (!token) return res.status(401).json({ error: 'Missing auth token' });

  // Verify the token belongs to THIS userId (not someone else)
  const { data: { user }, error: authError } = await supabaseAdmin.auth.getUser(token);
  if (authError || user?.id !== userId) {
    return res.status(401).json({ error: 'Unauthorized' });
  }

  try {
    const updatePayload = {
      is_active: true,
      updated_at: new Date().toISOString(),
    };
    if (first_name) updatePayload.first_name = first_name.trim();
    if (middle_name !== undefined) updatePayload.middle_name = middle_name?.trim() || null;
    if (last_name) updatePayload.last_name = last_name.trim();

    const { error } = await supabaseAdmin
      .from('users_tbl')
      .update(updatePayload)
      .eq('user_id', userId);

    if (error) throw error;
    res.json({ ok: true });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

app.listen(5000, () => console.log('Server running on port 5000'));
```

